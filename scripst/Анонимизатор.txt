	--======================
---- customers
	--=====================
SELECT  

     email, login, "name", phone,

	lower(left(email, 1) || '****@' || split_part(email, '@', 2)) AS xx_email,
    CASE 
        WHEN login IS NULL THEN NULL
        WHEN login = '' THEN ''
        ELSE lower(left(login, 1) || '****' || right(login, 1))
    END AS xx_login,
    CASE 
        WHEN "name" IS NULL THEN NULL
        WHEN "name" = 'unnamed' THEN 'unnamed'
        ELSE lower(left("name", 1) || '****' || right("name", 1))
    END AS xx_name,
	bardak.xx_phone
 
FROM customers

LEFT JOIN  LATERAL ( SELECT string_agg(ch, '') AS xx_phone FROM ( SELECT substr(phone, s, 1) AS ch FROM generate_series(1, length(phone)) AS s ORDER BY random() )) AS bardak ON true;
	
	
	

/*
SELECT  
     email, login, "name", phone,
	lower(left(email, 1) || '****@' || split_part(email, '@', 2)) AS xx_email,
    CASE 
        WHEN login IS NULL THEN NULL
        WHEN login = '' THEN ''
        ELSE lower(left(login, 1) || '****' || right(login, 1))
    END AS xx_login,
    CASE 
        WHEN "name" IS NULL THEN NULL
        WHEN "name" = 'unnamed' THEN 'unnamed'
        ELSE lower(left("name", 1) || '****' || right("name", 1))
    END AS xx_name,
	bardak.xx_phone
FROM customers
-- Вариент с перемешиванием имеющихся цифр: ORDER BY random()
LEFT JOIN 
	LATERAL ( SELECT string_agg(ch, '') AS xx_phone FROM ( SELECT substr(phone, s, 1) AS ch FROM generate_series(1, length(phone)) AS s ORDER BY random() )) AS bardak ON true;
*/

--SELECT id,  MAX(LENGTH(msg)) from messages where msg is not null and msg not like '%{%' and msg != '' group by id limit 1000

SELECT msg from messages where msg is not null and msg not like '%{%' and msg != '' and length(msg) between 1000 and 12597 -- 483 записи
SELECT msg from messages where msg is not null and msg not like '%{%' and msg != '' and length(msg) between 2000 and 12597 -- 37 записей
SELECT msg from messages where msg is not null and msg not like '%{%' and msg != '' and length(msg) between 3000 and 12597 -- 9 записей
SELECT msg from messages where msg is not null and msg not like '%{%' and msg != '' and length(msg) between 4000 and 12597 -- 4 записи
SELECT msg from messages where msg is not null and msg not like '%{%' and msg != '' and length(msg) = 12597 -- 1 запись



SELECT 
    information_schema.columns.table_name,
    information_schema.columns.column_name
FROM 
    information_schema.columns
JOIN 
    information_schema.tables 
    USING (table_schema, table_name)
WHERE 
    information_schema.columns.data_type = 'character varying'AND
	information_schema.tables.table_type = 'BASE TABLE' AND 
	information_schema.columns.table_schema = 'public' AND
	information_schema.columns.table_catalog = 'mbss_master'
ORDER BY 
    information_schema.columns.table_name, 
    information_schema.columns.column_name;
	
	
	
	SELECT *
FROM messages
WHERE msg !~ '^\s*{.*}$'; -- Regex to detect invalid JSON-like structure